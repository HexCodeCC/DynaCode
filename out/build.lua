--[[
This file was generated by DynaCodes project buider

DynaCode has been included in this package.

The developers source code has been serialised into a table easy
distribution.
]]
if not fs.exists( "DynaCode.lua" ) then
    print("Downloading DynaCode to location 'DynaCode.lua'")
    local response = http.get("https://raw.githubusercontent.com/HexCodeCC/DynaCode/master/bin/DynaCode-Stable.lua")

    if response then
        local f = fs.open( "DynaCode.lua", "w" )
        f.write( response.readAll() )
        f.close()
    else
        error("Failed to download DynaCode from URL 'https://raw.githubusercontent.com/HexCodeCC/DynaCode/master/bin/DynaCode-Stable.lua'", 0)
    end
end

-- DynaCode should be ready to be used by user source now. User source included below

local filesToUnpack = {
  [ "example/example.lua" ] = true,
  [ "example/main.dcml" ] = true,
}
local files = {
  [ "example/example.lua" ] = "local app = Application( term.getSize() ) -- Application requires width, height\
app.backgroundColour = colors.cyan\
\
local stage = app + Stage({\
    name = \"TestStage\";\
    X = 5;\
    Y = 5;\
    width = 15;\
    height = 7;\
    textColour = colors.lightGray;\
    titleTextColour = colors.white;\
    titleBackgroundColour = 128;\
    backgroundColour = colors.white;\
    title = \"Test Window\";\
})\
\
stage:replaceWithDCML( \"example/main.dcml\" )\
\
stage:addToController(\"submit\", function( self, event )\
    event:convertToRelative( self )\
    error(\"Button '\"..tostring( self ) .. \"' has been clicked. Position: \"..event.X..\", \"..event.Y)\
end)\
\
app:run()",
  [ "example/main.dcml" ] = "<Button X=\"2\" Y=\"2\" width=\"9\" height=\"4\" onTrigger=\"#submit\">Hello World</Button>",
}
local function runFromString( name, content )
    local fn, err = loadstring( content, name )
    if err then
        error("Failed to load user source file '"..name.."'. Reason: Possible Syntax Exception "..tostring( err ), 0)
    end

    local ok, err = pcall( fn )
    if err then
        error("Failed to execute user source file '"..name.."'. Reason: Uncaught Exception "..tostring( err ), 0)
    end
end

if files[ "example/example.lua" ] then
    runFromString( "example/example.lua", files[ "example/example.lua" ] )
    print("INIT file (example/example.lua) executed")
end

for name, content in pairs( files ) do
	if filesToUnpack[ name ] then
		local h = fs.open( name, "w" )
		h.write( content )
		h.close()
	else
		print("Running file "..name)
        runFromString( name, content )
	end
end
